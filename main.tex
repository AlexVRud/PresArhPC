\documentclass[10pt,pdf,ignorenonframetext]{beamer}
\usetheme{Madrid}

\usepackage[T2A]{fontenc}
\usepackage[cp1251]{inputenc}
\usepackage[russian]{babel}
\usepackage[warn]{mathtext}          % русские буквы в формулах, с предупреждением
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}

\usepackage{color}
\usepackage{xcolor}
\usepackage{graphicx}

\usepackage{subfigure}

\usepackage{tikz}
\usetikzlibrary{calc}
\usetikzlibrary{arrows}
\usetikzlibrary{topaths}
\usetikzlibrary{positioning}
\usetikzlibrary{decorations.pathmorphing}

\newcommand*{\ByteWidht}{0.9cm}
\newcommand*{\ByteHeight}{0.6cm}
\newcommand*{\DeltaWidht}{0.05cm}

\tikzset{
  databox/.style={draw,fill=white,minimum width=#1*\ByteWidht, minimum height=\ByteHeight, path picture={%
    \foreach \x in {0,...,4}%
      \draw (path picture bounding box.south west) ++(\x*\ByteWidht,0) -- ++(0,0.15*\ByteHeight);%
    }},
  databox/.default=4,
  partleft/.style={minimum width=\ByteWidht, text width=0.6*\ByteWidht, minimum height=\ByteHeight, align=right,
    append after command={
      \pgfextra{%
        \draw [fill=lightgray]%
          ($(\tikzlastnode.south east) + (-0.65*\ByteWidht-0.5*\pgflinewidth,0.5*\pgflinewidth)$)
       -- ($(\tikzlastnode.south east) + (-0.5*\pgflinewidth,0.5*\pgflinewidth)$)
       -- ($(\tikzlastnode.north east) + (-0.5*\pgflinewidth,-0.5*\pgflinewidth)$) %
       -- ++(-0.65*\ByteWidht,0) %
       -- ++(0.125*\ByteWidht,-0.25*\ByteHeight)
       -- ++(-0.25*\ByteWidht,-0.50*\ByteHeight)
       -- cycle;
      }
    }
  },
  partright/.style={minimum width=\ByteWidht, text width=0.6*\ByteWidht, minimum height=\ByteHeight, align=left,
    append after command={
      \pgfextra{%
        \draw [fill=lightgray]%
          ($(\tikzlastnode.south west) + (0.65*\ByteWidht+0.5*\pgflinewidth,0.5*\pgflinewidth)$)
       -- ($(\tikzlastnode.south west) + (0.5*\pgflinewidth,0.5*\pgflinewidth)$)
       -- ($(\tikzlastnode.north west) + (0.5*\pgflinewidth,-0.5*\pgflinewidth)$) %
       -- ++(0.65*\ByteWidht,0) %
       -- ++(0.125*\ByteWidht,-0.25*\ByteHeight)
       -- ++(-0.25*\ByteWidht,-0.50*\ByteHeight)
       -- cycle;
      }
    }
  },
  linkedbyte/.style={shape=rectangle,rounded corners,draw=green!80!black,dashed,%
     minimum width=\ByteWidht+2*\DeltaWidht, minimum height=\ByteHeight+2*\DeltaWidht
  }
}


\usepackage{bytefield}
\newcommand{\colorbitbox}[3]{%
\rlap{\bitbox{#2}{\color{#1}\rule{\width}{\height}}}%
\bitbox{#2}{#3}}
\newcommand{\memsection}[4]{
	\bytefieldsetup{bitheight=#3\baselineskip}	% define the height of the memsection
	\bitbox[]{8}{
		\texttt{0x\uppercase{#1}}	 % print end address
		\\ \vspace{#3\baselineskip} \vspace{-2\baselineskip} \vspace{-#3pt} % do some spacing
		\texttt{0x\uppercase{#2}} % print start address
	}
	\rlap{\bitbox{16}{\color{white}\rule{\width}{\height}}}%
\bitbox{16}{#4} % print box with caption
}

\begin{document}


\begin{frame}\frametitle{Основные элементы}
  \begin{columns}[T]
    \begin{column}[T]{5cm}
      \begin{block}{Байт}
        \begin{figure}
          \subfigure{\begin{tikzpicture}
\node[databox=1,text=blue] at (0,0) {'A'};
          \end{tikzpicture}}
          \subfigure{\begin{tikzpicture}
\node[databox=1, text=brown] at (0,0) {255};
          \end{tikzpicture}}
          \subfigure{\begin{tikzpicture}
\node[databox=1] at (0,0) {A0};
          \end{tikzpicture}}
        \end{figure}
      \end{block}
    \end{column}
    \begin{column}[T]{5cm}
      \begin{block}{Int32}
        \begin{figure}
          \subfigure{\begin{tikzpicture}
\node[databox=4,text=brown] at (0,0) {1234567890};
          \end{tikzpicture}}
        \end{figure}
      \end{block}
    \end{column}
  \end{columns}
  \begin{columns}[T]
    \begin{column}[T]{11cm}
      \begin{block}{Массив}
        \begin{figure}
          \subfigure{\begin{tikzpicture}
\foreach \x/\d in {0/{'H'}, 1/'e', 2/'l', 3/'l', 4/'o'}{
  \node[databox=1,text=blue] (tmp) at (\x*\ByteWidht,0) {\d};
  \node[text=green!80!black, below=0.03cm of tmp,scale=0.5] {\x};
}
\node[databox=1,text=brown] (tmp) at (5*\ByteWidht,0) {0};
\node[text=green!80!black, below=0.03cm of tmp,scale=0.5] {5};
          \end{tikzpicture}}
          \subfigure{\begin{tikzpicture}
\node[partleft] at (0,0) {...};
\begin{scope}[shift={(\ByteWidht,0)}]
\foreach \x/\d in {0/{'H'}, 1/'e', 2/'l', 3/'l', 4/'o'}{
  \node[databox=1,text=blue] (tmp) at (\x*\ByteWidht,0) {\d};
  \node[text=green!80!black, below=0.03cm of tmp,scale=0.5] {+\x};
}
\node[databox=1,text=brown] (tmp) at (5*\ByteWidht,0) {0};
\node[text=green!80!black, below=0.03cm of tmp,scale=0.5] {+5};
\end{scope}
\node[partright] at (7*\ByteWidht,0) {...};
          \end{tikzpicture}}
        \end{figure}
      \end{block}
    \end{column}
  \end{columns}
\end{frame}

\begin{frame}[fragile]\frametitle{Основные элементы}
      \begin{block}{Структура}
        \begin{figure}
          \subfigure{\begin{tikzpicture}%[scale=0.85, every node/.style={transform shape}]
\node[databox=4,text=brown] (id) {7172421}; \node[above=0 of id,text=magenta]{id};
\node[databox=1,right=-\pgflinewidth of id,text=blue] (a) {'A'}; \node[above=0 of a,text=magenta]{a};
\node[databox=1,right=-\pgflinewidth of a,text=blue] (b) {'B'}; \node[above=0 of b,text=magenta]{b};
\node[databox=2,right=-\pgflinewidth of b,text=blue, fill=lightgray] (none) {}; \node[above=0.5*\ByteHeight of none,text=green!30!black]  (lnone) {Что это?}; \draw[->,draw=green!30!black,thick] (lnone) -- (none);
\node[databox=4,right=-\pgflinewidth of none,text=brown] (sum) {7172421};  \node[above=0 of sum,text=magenta]{sum};
          \end{tikzpicture}}
          \subfigure{\begin{tikzpicture}%[scale=0.95, every node/.style={transform shape}]
\node[partleft] (tmp) at (0,0) {...};
\node[databox=4,right=-\pgflinewidth of tmp,text=brown] (x) {x=421}; \node[above=0 of x,text=magenta]{x};
\node[databox=4,right=-\pgflinewidth of x,text=brown] (y) {y=123}; \node[above=0 of y,text=magenta]{y};
\node[partright,right=-\pgflinewidth of y] {...};
          \end{tikzpicture}}
        \end{figure}
      \end{block}
      \begin{block}{Сложная структура}
        \begin{figure}
\begin{bytefield}{32}
    \bitheader{0,3,4,7,8,15,16,18,19,31}\\
    \colorbitbox{white}{4}{\textcolor{magenta}{\scriptsize Version}} &
    \colorbitbox{white}{4}{\scriptsize \textcolor{magenta}{Header length}} &
    \colorbitbox{white}{8}{\scriptsize \textcolor{magenta}{Differentiated Services}} &
    \colorbitbox{white}{16}{\textcolor{magenta}{\scriptsize Total Length}}\\
    \colorbitbox{white}{16}{\textcolor{magenta}{\scriptsize Identification}} &
    \colorbitbox{white}{3}{\textcolor{magenta}{\scriptsize Flags}} &
    \colorbitbox{white}{13}{\textcolor{magenta}{\scriptsize Fragment Offset}}\\
    \colorbitbox{white}{8}{\textcolor{magenta}{\scriptsize Time to Live}} &
    \colorbitbox{white}{8}{\textcolor{magenta}{\scriptsize Protocol}} &
    \colorbitbox{white}{16}{\textcolor{magenta}{\scriptsize Header Checksum}}\\
    \end{bytefield}
        \end{figure}
      \end{block}
\end{frame}

\begin{frame}[fragile]\frametitle{Основные элементы}
      \begin{block}{Память, например, документация от Intel}
        \begin{figure}
\footnotesize{
\begin{bytefield}{24}
	\memsection{ffff ffff}{0040 0000}{6}{-- free --}\\
	\begin{rightwordgroup}{internal memory}
		\memsection{003f ffff}{002f c000}{4}{Special Function Registers}\\
		\memsection{002f bfff}{0007 0000}{3}{-- reseved --}\\
		\memsection{0006 ffff}{0000 0000}{6}{Internal Flash}
	\end{rightwordgroup}\\
\end{bytefield}
}
        \end{figure}
      \end{block}
\end{frame}

\begin{frame}\frametitle{Структура данных <<стек>>}
  \begin{columns}[T]
    \begin{column}[T]{5cm}
      \begin{block}{Стек}
        \begin{figure}
          \begin{tikzpicture}
\node[databox=1,text=brown,anchor=south west] (s1) at (0,0) {1};
\node[databox=1,text=brown,anchor=south west] (s2) at (0,1*\ByteHeight) {2};
\node[databox=1,text=brown,anchor=south west] (s3) at (0,2*\ByteHeight) {3};
\draw[thick] (-0.1*\ByteWidht,5.1*\ByteHeight) --
             (-0.1*\ByteWidht,-0.1*\ByteHeight) --
             (1.1*\ByteWidht,-0.1*\ByteHeight) --
             (1.1*\ByteWidht,5.1*\ByteHeight);
\only<2>{
  \node[databox=1,text=brown,anchor=south west,fill=green!30!white] (s4in) at (-2.2*\ByteWidht,3*\ByteHeight) {4};
  \draw[->] (s4in) to[out=90,in=180] (-0.6*\ByteWidht,6*\ByteHeight) to[out=0,in=90] ($(s3) + (0,\ByteHeight)$);
}
\only<3,4>{
  \node[databox=1,text=brown,anchor=south west,fill=green!30!white] (s4) at (0,3*\ByteHeight) {4};
}
\only<3>{
  \draw[->,dotted] (-0.6*\ByteWidht,6*\ByteHeight) to[out=0,in=90] (s4);
}
\only<4>{
  \draw[->] (s4) to[out=90,in=180] (1.6*\ByteWidht,6*\ByteHeight);
}
\only<5>{
  \node[databox=1,text=brown,anchor=south west,fill=green!30!white] (s4out) at (2.2*\ByteWidht,3*\ByteHeight) {4};
  \draw[o->,dotted] ($(s3) + (0,\ByteHeight)$) to[out=90,in=180] (1.6*\ByteWidht,6*\ByteHeight) to[out=0,in=90] (s4out);
}
          \end{tikzpicture}
        \end{figure}
      \end{block}
    \end{column}
    \begin{column}[T]{5cm}
      \begin{block}{}
\only<1>{{\bf Стек} (англ. stack --- стопка; читается стэк) — структура данных, представляющая собой список элементов, организованных по принципу LIFO (англ. last in — first out, <<последним пришёл — первым вышел>>).}
\only<2,3>{<<Положить>> элемент в стек можно только на <<вершину>>.}
\only<4,5>{<<Взять>> из стека можно только верхний элемент.}
      \end{block}
    \end{column}
  \end{columns}
\end{frame}

\begin{frame}\frametitle{Стек в памяти}
  \begin{block}{Стек}
    \begin{figure}
      \begin{tikzpicture}
\only<1>{
  \node[databox=1,text=brown,anchor=south west] (s3) at (0,0) {3};
  \node[databox=1,text=brown,anchor=south west] (s2) at (1*\ByteWidht,0) {2};
  \node[databox=1,text=brown,anchor=south west] (s1) at (2*\ByteWidht,0) {1};
  \draw[thick] (-1.1*\ByteWidht,-0.1*\ByteHeight) --
               (3.1*\ByteWidht,-0.1*\ByteHeight) --
               (3.1*\ByteWidht,1.1*\ByteHeight) --
               (-1.1*\ByteWidht,1.1*\ByteHeight);
}
\only<2,3>{
  \node[partleft] at (0,0) {...};
  \begin{scope}[shift={(\ByteWidht,0)}]
     \node[databox=3,fill=lightgray] at (1*\ByteWidht,0) {};
     \foreach \x/\d in {0/{3}, 1/{2}, 2/{1}}{
       \node[databox=1,text=brown] (tmp\x) at (3*\ByteWidht + \x*\ByteWidht,0) {\d};
       \node[text=green!80!black, below=0.03cm of tmp\x,scale=0.5] {+\x};
     }
  \end{scope}
  \node[partright] at (7*\ByteWidht,0) {...};
}
\only<3>{
  \node[linkedbyte] (headofstack) at (tmp0) {};
  \node[text=black, above=of headofstack] (ESP) {ESP};
  \draw[->,draw=violet,thick] (ESP) -- (headofstack);
}
\only<4>{
  \node[partleft] (tmp) at (0,0) {...};
  \node[databox=3,fill=lightgray, right=-\pgflinewidth of tmp] (tmp) {};
  \node[databox=4,text=brown,right=-\pgflinewidth of tmp] (tmpx) {1234567890};
  \node[linkedbyte,right=-\pgflinewidth-\DeltaWidht of tmp] (headofstack) {};
  \node[text=black, above=of headofstack] (ESP) {ESP};
  \draw[->,draw=violet,thick] (ESP) -- (headofstack);
  \node[databox=2,text=brown,right=-\pgflinewidth of tmpx] (tmpx) {1234};
  \node[databox=1,text=blue,right=-\pgflinewidth of tmpx] (tmpx) {'A'};
  \node[databox=1,text=blue,right=-\pgflinewidth of tmpx] (tmpx) {'B'};
  \node[partright,right=-\pgflinewidth of tmpx] {...};
}
      \end{tikzpicture}
    \end{figure}
  \end{block}
  \begin{block}{}
    \begin{itemize}
      \only<1>{%
        \item Теперь рассмотрим как стек храниться в памяти.
        \item Повернём его на бок.
        \item Тогда элементы стека будут расположены как в массиве
      }
      \only<2>{%
        \item И представление стека в памяти может быть таким.
      }
      \only<3>{%
        \item Добавим ссылку на вершину (позже узнаем почему именно ESP).
      }
      \only<4>{%
        \item В стеке могут храниться не только однобайтовые элементы.
        \item Но вершина стека --- это первый хранящейся байт в нём.
      }
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}\frametitle{Стек и процессор}
  \begin{block}{}
    \begin{itemize}
      \item Стек --- аппаратно реализованная структура в процессоре.
      \item Он хранится в специальном <<сегменте>> оперативной памяти.
      \item На вершину стека смотрит <<регистр процессора>> ESP.
      \item Для работы со стеком доступны команды {\bf push} и {\bf pop}.
      \item Стек используется не только для хранения данных, но и для вызова подпрограмм.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}\frametitle{Регистры процессора}
  \begin{block}{}
    \begin{itemize}
      \item Регистр процессора --- блок ячеек памяти, образующий сверхбыструю оперативную память внутри процессора
      \item Размер регистра, как правило зависит от разрядности процессора (или его режима).
      \item Регистры имеют имена: EAX, AX, ESP, EIP и т.д.
      \item Регистры разбиваются на функциональные группы, и не все они могут быть доступны программисту.
      \item В рамках курса мы рассмотрим только несколько видов регистров, доступных при программировании прикладного ПО.
    \end{itemize}
  \end{block}
\end{frame}

\end{document}
