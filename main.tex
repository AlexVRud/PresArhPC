\documentclass[10pt,pdf,ignorenonframetext]{beamer}
\usetheme{Madrid}
\title[]{Архитектура компьютера}
\subtitle{Введение в Ассемблер}
\author[]{Александр Рудал\"ев}
\institute[]{ИМИКТ САФУ}
\date[]{Архангельск, 2015}

\usepackage[T2A]{fontenc}
\usepackage[cp1251]{inputenc}
\usepackage[russian]{babel}
\usepackage[warn]{mathtext}          % русские буквы в формулах, с предупреждением
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}

\usepackage{color}
\usepackage{xcolor}
\usepackage{graphicx}

\usepackage{subfigure}

\usepackage{tikz}
\usetikzlibrary{calc}
\usetikzlibrary{arrows}
\usetikzlibrary{topaths}
\usetikzlibrary{positioning}
\usetikzlibrary{decorations.pathmorphing}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{backgrounds}

\newcommand*{\ByteWidht}{0.9cm}
\newcommand*{\ByteHeight}{0.6cm}
\newcommand*{\DeltaWidht}{0.05cm}

\tikzset{
  databox/.style={draw,fill=white,minimum width=#1*\ByteWidht, minimum height=\ByteHeight, path picture={%
    \ifnum#1>1
      \foreach \x in {1,...,#1}%
        \draw (path picture bounding box.south west) ++(\x*\ByteWidht,0) -- ++(0,0.15*\ByteHeight);%
    \fi
    }
  },
  databox/.default=4,
  partleft/.style={minimum width=\ByteWidht, text width=0.6*\ByteWidht, minimum height=\ByteHeight, align=right,
    append after command={
      \pgfextra{%
        \draw [fill=lightgray]%
          ($(\tikzlastnode.south east) + (-0.65*\ByteWidht-0.5*\pgflinewidth,0.5*\pgflinewidth)$)
       -- ($(\tikzlastnode.south east) + (-0.5*\pgflinewidth,0.5*\pgflinewidth)$)
       -- ($(\tikzlastnode.north east) + (-0.5*\pgflinewidth,-0.5*\pgflinewidth)$) %
       -- ++(-0.65*\ByteWidht,0) %
       -- ++(0.125*\ByteWidht,-0.25*\ByteHeight)
       -- ++(-0.25*\ByteWidht,-0.50*\ByteHeight)
       -- cycle;
      }
    }
  },
  partright/.style={minimum width=\ByteWidht, text width=0.6*\ByteWidht, minimum height=\ByteHeight, align=left,
    append after command={
      \pgfextra{%
        \draw [fill=lightgray]%
          ($(\tikzlastnode.south west) + (0.65*\ByteWidht+0.5*\pgflinewidth,0.5*\pgflinewidth)$)
       -- ($(\tikzlastnode.south west) + (0.5*\pgflinewidth,0.5*\pgflinewidth)$)
       -- ($(\tikzlastnode.north west) + (0.5*\pgflinewidth,-0.5*\pgflinewidth)$) %
       -- ++(0.65*\ByteWidht,0) %
       -- ++(0.125*\ByteWidht,-0.25*\ByteHeight)
       -- ++(-0.25*\ByteWidht,-0.50*\ByteHeight)
       -- cycle;
      }
    }
  },
  linkedbyte/.style={shape=rectangle,rounded corners,draw=green!80!black,dashed,%
     minimum width=\ByteWidht+2*\DeltaWidht, minimum height=\ByteHeight+2*\DeltaWidht
  },
  code/.style={shape=rectangle, draw=green!50!black, anchor=north west, outer sep=0, inner sep = 0},
  qahigh/.style={fill=lightgray, minimum height=\baselineskip, inner sep=0, inner ysep=0, anchor=north west}
}

\newcommand{\qahigh}[1]{%
  \foreach \x in {#1} {%
    \node[qahigh] at (0, 1 * \baselineskip + -1 * \x * \baselineskip) {
% Example for use of graphics for highlighting
% uncomment and set graphics file for usage
%        \begin{flushright}
%        \includegraphics[height=\baselineskip]{graphics/left-arrow.pdf}
%        \end{flushright}
    };
  }
}

\usepackage{bytefield}
\newcommand{\colorbitbox}[3]{%
\rlap{\bitbox{#2}{\color{#1}\rule{\width}{\height}}}%
\bitbox{#2}{#3}}
\newcommand{\memsection}[4]{
	\bytefieldsetup{bitheight=#3\baselineskip}	% define the height of the memsection
	\bitbox[]{8}{
		\texttt{0x\uppercase{#1}}	 % print end address
		\\ \vspace{#3\baselineskip} \vspace{-2\baselineskip} \vspace{-#3pt} % do some spacing
		\texttt{0x\uppercase{#2}} % print start address
	}
	\rlap{\bitbox{16}{\color{white}\rule{\width}{\height}}}%
\bitbox{16}{#4} % print box with caption
}

\usepackage{listings}
\lstset{
        basicstyle=\ttfamily,
        keywordstyle=\bf,
        stringstyle=\bf,
        commentstyle=\it,
        showspaces=false,
        showstringspaces=false,
        showtabs=true,
        tabsize=4,
        breaklines=true,
	extendedchars=true,
	language={[x86masm]Assembler},
	morekeywords={global, extern, section, .text, .bss},
        escapeinside=\`\`,
        moredelim=**[is][\it]{`}{`},
        numbers=left,
        numberstyle=\tiny,
        numbersep=5pt,
        lineskip=0pt,aboveskip=0pt,belowskip=0pt, % Уменьшаем отступы для вставки в tikz
        framesep=0pt,rulesep=0px,framerule=0pt,   %
%        xleftmargin=8mm,
%        frame=single,framexleftmargin=8mm, xleftmargin=8mm,
}

\newcommand{\cl}[1]{\texttt{\bf #1}}

\begin{document}

\frame{\titlepage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Основные элементы
%%
\begin{frame}\frametitle{Основные элементы}
  \begin{columns}[T]
    \begin{column}[T]{5cm}
      \begin{block}{Байт}
        \begin{figure}
          \subfigure{\begin{tikzpicture}
\node[databox=1,text=blue] at (0,0) {'A'};
          \end{tikzpicture}}
          \subfigure{\begin{tikzpicture}
\node[databox=1, text=brown] at (0,0) {255};
          \end{tikzpicture}}
          \subfigure{\begin{tikzpicture}
\node[databox=1] at (0,0) {A0};
          \end{tikzpicture}}
        \end{figure}
      \end{block}
    \end{column}
    \begin{column}[T]{5cm}
      \begin{block}{Int32}
        \begin{figure}
          \subfigure{\begin{tikzpicture}
\node[databox=4,text=brown] at (0,0) {1234567890};
          \end{tikzpicture}}
        \end{figure}
      \end{block}
    \end{column}
  \end{columns}
  \begin{columns}[T]
    \begin{column}[T]{11cm}
      \begin{block}{Массив}
        \begin{figure}
          \subfigure{\begin{tikzpicture}
\foreach \x/\d in {0/{'H'}, 1/'e', 2/'l', 3/'l', 4/'o'}{
  \node[databox=1,text=blue] (tmp) at (\x*\ByteWidht,0) {\d};
  \node[text=green!80!black, below=0.03cm of tmp,scale=0.5] {\x};
}
\node[databox=1,text=brown] (tmp) at (5*\ByteWidht,0) {0};
\node[text=green!80!black, below=0.03cm of tmp,scale=0.5] {5};
          \end{tikzpicture}}
          \subfigure{\begin{tikzpicture}
\node[partleft] at (0,0) {...};
\begin{scope}[shift={(\ByteWidht,0)}]
\foreach \x/\d in {0/{'H'}, 1/'e', 2/'l', 3/'l', 4/'o'}{
  \node[databox=1,text=blue] (tmp) at (\x*\ByteWidht,0) {\d};
  \node[text=green!80!black, below=0.03cm of tmp,scale=0.5] {+\x};
}
\node[databox=1,text=brown] (tmp) at (5*\ByteWidht,0) {0};
\node[text=green!80!black, below=0.03cm of tmp,scale=0.5] {+5};
\end{scope}
\node[partright] at (7*\ByteWidht,0) {...};
          \end{tikzpicture}}
        \end{figure}
      \end{block}
    \end{column}
  \end{columns}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Основные элементы
%%
\begin{frame}[fragile]\frametitle{Основные элементы}
      \begin{block}{Структура}
        \begin{figure}
          \subfigure{\begin{tikzpicture}%[scale=0.85, every node/.style={transform shape}]
\node[databox=4,text=brown] (id) {7172421}; \node[above=0 of id,text=magenta]{id};
\node[databox=1,right=-\pgflinewidth of id,text=blue] (a) {'A'}; \node[above=0 of a,text=magenta]{a};
\node[databox=1,right=-\pgflinewidth of a,text=blue] (b) {'B'}; \node[above=0 of b,text=magenta]{b};
\node[databox=2,right=-\pgflinewidth of b,text=blue, fill=lightgray] (none) {}; \node[above=0.5*\ByteHeight of none,text=green!30!black]  (lnone) {Что это?}; \draw[->,draw=green!30!black,thick] (lnone) -- (none);
\node[databox=4,right=-\pgflinewidth of none,text=brown] (sum) {7172421};  \node[above=0 of sum,text=magenta]{sum};
          \end{tikzpicture}}
          \subfigure{\begin{tikzpicture}%[scale=0.95, every node/.style={transform shape}]
\node[partleft] (tmp) at (0,0) {...};
\node[databox=4,right=-\pgflinewidth of tmp,text=brown] (x) {x=421}; \node[above=0 of x,text=magenta]{x};
\node[databox=4,right=-\pgflinewidth of x,text=brown] (y) {y=123}; \node[above=0 of y,text=magenta]{y};
\node[partright,right=-\pgflinewidth of y] {...};
          \end{tikzpicture}}
        \end{figure}
      \end{block}
      \begin{block}{Сложная структура}
        \begin{figure}
\begin{bytefield}{32}
    \bitheader{0,3,4,7,8,15,16,18,19,31}\\
    \colorbitbox{white}{4}{\textcolor{magenta}{\scriptsize Version}} &
    \colorbitbox{white}{4}{\scriptsize \textcolor{magenta}{Header length}} &
    \colorbitbox{white}{8}{\scriptsize \textcolor{magenta}{Differentiated Services}} &
    \colorbitbox{white}{16}{\textcolor{magenta}{\scriptsize Total Length}}\\
    \colorbitbox{white}{16}{\textcolor{magenta}{\scriptsize Identification}} &
    \colorbitbox{white}{3}{\textcolor{magenta}{\scriptsize Flags}} &
    \colorbitbox{white}{13}{\textcolor{magenta}{\scriptsize Fragment Offset}}\\
    \colorbitbox{white}{8}{\textcolor{magenta}{\scriptsize Time to Live}} &
    \colorbitbox{white}{8}{\textcolor{magenta}{\scriptsize Protocol}} &
    \colorbitbox{white}{16}{\textcolor{magenta}{\scriptsize Header Checksum}}\\
    \end{bytefield}
        \end{figure}
      \end{block}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Основные элементы
%%
\begin{frame}[fragile]\frametitle{Основные элементы}
      \begin{block}{Память, например, документация от Intel}
        \begin{figure}
\footnotesize{
\begin{bytefield}{24}
	\memsection{ffff ffff}{0040 0000}{6}{-- free --}\\
	\begin{rightwordgroup}{internal memory}
		\memsection{003f ffff}{002f c000}{4}{Special Function Registers}\\
		\memsection{002f bfff}{0007 0000}{3}{-- reseved --}\\
		\memsection{0006 ffff}{0000 0000}{6}{Internal Flash}
	\end{rightwordgroup}\\
\end{bytefield}
}
        \end{figure}
      \end{block}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Структура данных <<стек>>
%%
\begin{frame}\frametitle{Структура данных <<стек>>}
  \begin{columns}[T]
    \begin{column}[T]{5cm}
      \begin{block}{Стек}
        \begin{figure}
          \begin{tikzpicture}
\node[databox=1,text=brown,anchor=south west] (s1) at (0,0) {1};
\node[databox=1,text=brown,anchor=south west] (s2) at (0,1*\ByteHeight) {2};
\node[databox=1,text=brown,anchor=south west] (s3) at (0,2*\ByteHeight) {3};
\draw[thick] (-0.1*\ByteWidht,5.1*\ByteHeight) --
             (-0.1*\ByteWidht,-0.1*\ByteHeight) --
             (1.1*\ByteWidht,-0.1*\ByteHeight) --
             (1.1*\ByteWidht,5.1*\ByteHeight);
\only<2>{
  \node[databox=1,text=brown,anchor=south west,fill=green!30!white] (s4in) at (-2.2*\ByteWidht,3*\ByteHeight) {4};
  \draw[->] (s4in) to[out=90,in=180] (-0.6*\ByteWidht,6*\ByteHeight) to[out=0,in=90] ($(s3) + (0,\ByteHeight)$);
}
\only<3,4>{
  \node[databox=1,text=brown,anchor=south west,fill=green!30!white] (s4) at (0,3*\ByteHeight) {4};
}
\only<3>{
  \draw[->,dotted] (-0.6*\ByteWidht,6*\ByteHeight) to[out=0,in=90] (s4);
}
\only<4>{
  \draw[->] (s4) to[out=90,in=180] (1.6*\ByteWidht,6*\ByteHeight);
}
\only<5>{
  \node[databox=1,text=brown,anchor=south west,fill=green!30!white] (s4out) at (2.2*\ByteWidht,3*\ByteHeight) {4};
  \draw[o->,dotted] ($(s3) + (0,\ByteHeight)$) to[out=90,in=180] (1.6*\ByteWidht,6*\ByteHeight) to[out=0,in=90] (s4out);
}
          \end{tikzpicture}
        \end{figure}
      \end{block}
    \end{column}
    \begin{column}[T]{5cm}
      \begin{block}{}
\only<1>{{\bf Стек} (англ. stack --- стопка; читается стэк) — структура данных, представляющая собой список элементов, организованных по принципу LIFO (англ. last in — first out, <<последним пришёл — первым вышел>>).}
\only<2,3>{<<Положить>> элемент в стек можно только на <<вершину>>.}
\only<4,5>{<<Взять>> из стека можно только верхний элемент.}
      \end{block}
    \end{column}
  \end{columns}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Стек в памяти
%%
\begin{frame}\frametitle{Стек в памяти}
  \begin{block}{Стек}
    \begin{figure}
      \begin{tikzpicture}
\only<1>{
  \node[databox=1,text=brown,anchor=south west] (s3) at (0,0) {3};
  \node[databox=1,text=brown,anchor=south west] (s2) at (1*\ByteWidht,0) {2};
  \node[databox=1,text=brown,anchor=south west] (s1) at (2*\ByteWidht,0) {1};
  \draw[thick] (-1.1*\ByteWidht,-0.1*\ByteHeight) --
               (3.1*\ByteWidht,-0.1*\ByteHeight) --
               (3.1*\ByteWidht,1.1*\ByteHeight) --
               (-1.1*\ByteWidht,1.1*\ByteHeight);
}
\only<2,3>{
  \node[partleft] at (0,0) {...};
  \begin{scope}[shift={(\ByteWidht,0)}]
     \node[databox=3,fill=lightgray] at (1*\ByteWidht,0) {};
     \foreach \x/\d in {0/{3}, 1/{2}, 2/{1}}{
       \node[databox=1,text=brown] (tmp\x) at (3*\ByteWidht + \x*\ByteWidht,0) {\d};
       \node[text=green!80!black, below=0.03cm of tmp\x,scale=0.5] {+\x};
     }
  \end{scope}
  \node[partright] at (7*\ByteWidht,0) {...};
}
\only<3>{
  \node[linkedbyte] (headofstack) at (tmp0) {};
  \node[text=black, above=of headofstack] (ESP) {ESP};
  \draw[->,draw=violet,thick] (ESP) -- (headofstack);
}
\only<4>{
  \node[partleft] (tmp) at (0,0) {...};
  \node[databox=3,fill=lightgray, right=-\pgflinewidth of tmp] (tmp) {};
  \node[databox=4,text=brown,right=-\pgflinewidth of tmp] (tmpx) {1234567890};
  \node[linkedbyte,right=-\pgflinewidth-\DeltaWidht of tmp] (headofstack) {};
  \node[text=black, above=of headofstack] (ESP) {ESP};
  \draw[->,draw=violet,thick] (ESP) -- (headofstack);
  \node[databox=2,text=brown,right=-\pgflinewidth of tmpx] (tmpx) {1234};
  \node[databox=1,text=blue,right=-\pgflinewidth of tmpx] (tmpx) {'A'};
  \node[databox=1,text=blue,right=-\pgflinewidth of tmpx] (tmpx) {'B'};
  \node[partright,right=-\pgflinewidth of tmpx] {...};
}
      \end{tikzpicture}
    \end{figure}
  \end{block}
  \begin{block}{}
    \begin{itemize}
      \only<1>{%
        \item Теперь рассмотрим как стек храниться в памяти.
        \item Повернём его на бок.
        \item Тогда элементы стека будут расположены как в массиве
      }
      \only<2>{%
        \item И представление стека в памяти может быть таким.
      }
      \only<3>{%
        \item Добавим ссылку на вершину (позже узнаем почему именно ESP).
      }
      \only<4>{%
        \item В стеке могут храниться не только однобайтовые элементы.
        \item Но вершина стека --- это первый хранящейся байт в нём.
      }
    \end{itemize}
  \end{block}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Стек и процессор
%%
\begin{frame}\frametitle{Стек и процессор}
  \begin{block}{}
    \begin{itemize}
      \item Стек --- аппаратно реализованная структура в процессоре.
      \item Он хранится в специальном <<сегменте>> оперативной памяти.
      \item На вершину стека смотрит <<регистр процессора>> ESP.
      \item Для работы со стеком доступны команды {\bf push} и {\bf pop}.
      \item Стек используется не только для хранения данных, но и для вызова подпрограмм.
    \end{itemize}
  \end{block}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Регистры процессора
%%
\begin{frame}\frametitle{Регистры процессора}
  \begin{block}{}
    \begin{itemize}
      \item Регистр процессора --- блок ячеек памяти, образующий сверхбыструю оперативную память внутри процессора
      \item Размер регистра, как правило зависит от разрядности процессора (или его режима).
      \item Регистры имеют имена: EAX, AX, ESP, EIP и т.д.
      \item Регистры разбиваются на функциональные группы, и не все они могут быть доступны программисту.
      \item В рамках курса мы рассмотрим только несколько видов регистров, доступных при программировании прикладного ПО.
    \end{itemize}
  \end{block}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Регистр AX
%%
\begin{frame}\frametitle{Регистр AX}
  \begin{block}{Регистр}
    \begin{figure}
      \begin{tikzpicture}
\only<1>{
  \node[databox=2,text=brown] (AX) at (0,0) {};
  \node[left=0cm of AX] {AX};
}
\only<2>{
  \node[databox=1] (AH) at (0,0) {B2};
  \node[databox=1,right=-\pgflinewidth of AH] (AL) {A1};
  \node[left=0cm of AH] {AX};
  \node[above=0cm of AH] {AH};
  \node[above=0cm of AL] {AL};
}
\only<3,4>{
  \node[databox=2] (EA16) at (0,0) {};
  \node[databox=1,right=-\pgflinewidth of EA16] (AH){};
  \node[databox=1,right=-\pgflinewidth of AH] (AL) {};
  \node[above=0cm of AH] {AH};
  \node[above=0cm of AL] {AL};
  \draw [decorate,decoration={brace,amplitude=5pt,mirror,raise=1pt}]
    (1*\ByteWidht,-0.5*\ByteHeight) -- (3*\ByteWidht,-0.5*\ByteHeight) node [midway,yshift=-12pt] {AX} ;
}
\only<3>{
  \node[left=0cm of EA16] {EAX};
}
\only<4>{
  \node[databox=4,left=-\pgflinewidth of EA16] (RA32) {};
  \node[left=0cm of RA32] {RAX};
  \draw [decorate,decoration={brace,amplitude=5pt,mirror,raise=1pt}]
    (-1*\ByteWidht,-0.5*\ByteHeight-15pt) -- (3*\ByteWidht,-0.5*\ByteHeight-15pt) node [midway,yshift=-12pt] {EAX} ;
}
\only<5>{
  \node[databox=1,text=brown] (EAX) at (0,0) {1234567890};
  \node[left=0cm of EAX] {EAX};
}
      \end{tikzpicture}
    \end{figure}
  \end{block}
  \begin{block}{}
    \begin{itemize}
      \only<1>{%
        \item AX --- 16-битный регистр общего назначения.
      }
      \only<2>{%
        \item Для доступа к младшему байту регистра AX используется имя AL.
        \item Для доступа к старшему байту регистра AX используется имя AH.
        \item В приведённом примере:
        \begin{itemize}
          \item AX=0xB2A2,
          \item AH=0xB2,
          \item AL=0xA1
        \end{itemize}
        \item Внимание!!! Регистры AL, AH, AX используют те же самые два байта в памяти!!!
      }
      \only<3>{%
        \item В 32-битном режиме регистр AX расширяется до регистра EAX.
        \item Доступ к частям регистра сохраняется.
        \item Например, для EAX=0xD4C3B2A1 получим, что:
        \begin{itemize}
          \item AX=0xB2A2,
          \item AH=0xB2,
          \item AL=0xA1
        \end{itemize}
      }
      \only<4>{%
        \item В 64-битном режиме регистр AX расширяется до регистра RAX.
        \item Все те же свойства, как и в 32-битном режиме, для регистра сохраняются.
      }
      \only<5>{%
        \item Для сокращения размера изображения, будем обозначать регистр простым блоком, т.к. его размер известен.
      }
    \end{itemize}
  \end{block}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Список регистров
%%
\begin{frame}\frametitle{Список регистров}
  \footnotesize
  \begin{columns}[T]
    \begin{column}[T]{5.5cm}
      \begin{block}{Общего назначения}
        \begin{itemize}
          \item RAX,EAX,AX,AH,AL (Аккумулятор)
          \item RBX,EBX,BX,BH,BL
          \item RCX,ECX,CX,CH,CL (Счётчик)
          \item RDX,EDX,DX,DH,DL
          \item R8-R15
        \end{itemize}
      \end{block}
      \begin{block}{Сегментные}
        \begin{itemize}
          \item CS (Code Segment)
          \item DS (Data Segment)
          \item SS (Stack Segment)
          \item ES (Extra Segment)
          \item FS
          \item GS
        \end{itemize}
      \end{block}
    \end{column}
    \begin{column}[T]{5.5cm}
      \begin{block}{Ссылки}
        \begin{itemize}
          \item RIP,EIP,IP (Следующая команда)
          \item RSP,ESP,SP,SPL (Стек)
          \item RBP,EBP,BP,BPL
          \item RSI,ESI,SI,SIL (Источник)
          \item RDI,EDI,DI,DIL (Назначение)
        \end{itemize}
      \end{block}
      \begin{block}{Регистр флагов}
        \begin{itemize}
          \item RFLAGS,EFLAGS,FLAGS
        \end{itemize}
      \end{block}
      \begin{block}{Системные регистры}
        \begin{itemize}
          \item ...
        \end{itemize}
      \end{block}
    \end{column}
  \end{columns}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Структура программы на Ассемблере
%%
\begin{frame}[fragile]\frametitle{Структура программы на Ассемблере}
  \begin{columns}[T]
    \begin{column}[T]{6cm}
      \begin{exampleblock}{Hello world}
        \begin{figure}
          \begin{tikzpicture}[scale=0.6, every node/.style={scale=0.6}]
%\tikzstyle{qahigh}=[fill=lightgray,text width=1.6\textwidth,%
%           minimum height=\baselineskip, inner sep=0, inner ysep=0, anchor=north west]
\node[code] at (0,0) {%
  \begin{minipage}{1.6\textwidth}
    \begin{lstlisting}[]
global  _main
extern  _ExitProcess@4
extern  _printf

section .text   use32
_main:
        push    msg
        call    _printf

        xor     eax, eax
        push    eax
        call    _ExitProcess@4
section .data
msg     db "Hello World!!!", 13, 10, 0
    \end{lstlisting}
  \end{minipage}
};
\begin{pgfonlayer}{background}
  \begin{scope}[every node/.style={scale=0.6, text width=1.6\textwidth}]
    \only<1>{\qahigh{1,2,3,6}}
    \only<2>{\qahigh{5,13}}
    \only<3>{\qahigh{7,...,12}}
    \only<4>{\qahigh{14}}
  \end{scope}
\end{pgfonlayer}
          \end{tikzpicture}
        \end{figure}
      \end{exampleblock}
    \end{column}
    \begin{column}[T]{4cm}
      \begin{block}{}
\only<1>{Объявление глобальных и используемых имён.

\footnotesize\it {\bf global} --- сообщаем какие имена необходимо сделать видимыми в создаваемом объектном файле.

{\bf extern} --- какие имена нам понадобятся из других объектных файлов. Т.е., например, функции внешних библиотек.}
\only<2>{Объявление секций кода и данных.}
\only<3>{Код программы.

\footnotesize\it Как правило, используется выравнивание кода по трём колонкам шириной 8 символов:
метки, команды, параметры.}
\only<4>{Константы}
      \end{block}
    \end{column}
  \end{columns}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Команды языка Ассемблер: mov
%%
\begin{frame}\frametitle{Команды языка Ассемблер: mov}
  \begin{block}{Прототип}
    \cl{mov \{приёмник\}, \{источник\}}
  \end{block}
  \begin{block}{}
    \begin{itemize}
      \item Команда \cl{mov} копирует значение из источника в приёмник.
      \item Приёмником может выступать регистр или участок памяти. Источником --- регистр, участок памяти или значение.
      \item Приёмник и источник должны быть одного размера.
    \end{itemize}
  \end{block}
  \begin{exampleblock}{Примеры}
    \cl{mov eax, 123} \texttt{\it; Поместить в регист eax число 123}

    \cl{mov eax, [A]} \texttt{\it; Поместить в регист eax значение переменной A}

    \cl{mov eax, msg} \texttt{\it; Поместить в регист eax адрес переменной msg}
  \end{exampleblock}
  \begin{alertblock}{Неправильные примеры}
    \cl{mov al, cx}
  \end{alertblock}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Команды языка Ассемблер: add
%%
\begin{frame}\frametitle{Команды языка Ассемблер: add}
  \begin{block}{Прототип}
    \cl{add \{назначение\}, \{источник/значение\}}
  \end{block}
  \begin{block}{}
    \begin{itemize}
      \item Команда сложения двух одинаковых целых чисел (\{назначение\} и \{источник/значение\}).
      \item Результат сложения помещается в \{назначение\}.
    \end{itemize}
  \end{block}
  \begin{exampleblock}{Примеры}
    \cl{add eax, 123} \texttt{\it; Прибавить к регистру eax число 123}

    \cl{add eax, ebx} \texttt{\it; Прибавить к регистру eax регистр ebx}
  \end{exampleblock}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Вызов подпрограммы
%%
\begin{frame}[fragile]\frametitle{Вызов подпрограммы}
  \begin{block}{}
  \begin{figure}
    \begin{tikzpicture}
\node[code,scale=0.5] (code) at (0,0) {%
  \begin{minipage}{1.5\textwidth}
    \begin{lstlisting}[]
        push    ecx     ; <--- y
        push    edx     ; <--- x
        call    my_sum  ; <--- my_sum(x,y)
        ; тут некая команда
...
my_sum:
        push    ebx     ; Используемые регистры помещаем в стек
        mov     eax, [esp+8]
        mov     ebx, [esp+12]
        add     eax, ebx
        pop     ebx
        ret     8       ; Возвращаемся и удаляем параметры из стека
    \end{lstlisting}
  \end{minipage}
};
\foreach \yy in {1,...,12} {
  \coordinate (l\yy) at (-8pt,-0.5*\yy*\baselineskip+0.25*\baselineskip);
}
\only<1>{\node[databox=1] (EIP) at (0,3*\ByteHeight) {};}
\only<2,3,4,5,6,7,8,9>{\node[databox=1,fill=green!30!white] (EIP) at (0,3*\ByteHeight) {};}
\node[left=0cm of EIP] {EIP};
%
\only<1,2,3,4>{\node[databox=1,text=brown,right=of EIP] (EAX) {?};}
\only<5>{\node[databox=1,text=brown,fill=green!30!white,right=of EIP] {32};}
\only<6>{\node[databox=1,text=brown,fill=green!30!white,right=of EIP] {75};}
\only<7,8,9>{\node[databox=1,text=brown,right=of EIP] (EAX) {75};}
%
\node[left=0cm of EAX] (leax) {EAX};
\only<1,2,3,4,8,9>{\node[databox=1,text=brown,right=of EAX] (EBX) {32};}
\only<5>{\node[databox=1,text=brown,fill=green!30!white,right=of EAX] (EBX) {43};}
\only<6>{\node[databox=1,text=brown,right=of EAX] (EBX) {43};}
\only<7>{\node[databox=1,text=brown,fill=green!30!white,right=of EAX] (EBX) {32};}
%
\node[left=0cm of EBX] {EBX};
\node[databox=1,text=brown,right=of EBX] (ECX) {43};
\node[left=0cm of ECX] {ECX};
\only<1,5,6,9>{\node[databox=1,text=brown,right=of ECX] (ESP) {};}
\only<2,3,4,7,8>{\node[databox=1,fill=green!30!white,text=brown,right=of ECX] (ESP) {};}
\node[left=0cm of ESP] {ESP};
%
\begin{scope}[xshift=-1*\ByteWidht,yshift=1*\ByteHeight,scale=0.6, every node/.style={scale=0.6}]
  \node[partleft] (tmp) at (0,0) {...};
  \only<1,8,9>{%
    \node[databox=17,fill=lightgray,right=-\pgflinewidth of tmp] (tmp) {};
    \node[databox=1,right=-\pgflinewidth of tmp] (data) {?};
  }
  \only<2>{%
    \node[databox=9,fill=lightgray,right=-\pgflinewidth of tmp] (tmp) {};
    \node[databox=4,fill=green!30!white,right=-\pgflinewidth of tmp] (data) {32};
    \node[databox=4,fill=green!30!white,right=-\pgflinewidth of data] (data) {43};
    \node[databox=1,right=-\pgflinewidth of data] (data) {?};
  }
  \only<3>{%
    \node[databox=5,fill=lightgray,right=-\pgflinewidth of tmp] (tmp) {};
    \node[databox=4,fill=green!30!white,right=-\pgflinewidth of tmp] (rptr) {return ptr};
    \node[databox=4,right=-\pgflinewidth of rptr] (data) {32};
    \node[databox=4,right=-\pgflinewidth of data] (data) {43};
    \node[databox=1,right=-\pgflinewidth of data] (data) {?};
  }
  \only<4>{%
    \node[databox=1,fill=lightgray,right=-\pgflinewidth of tmp] (tmp) {};
    \node[databox=4,fill=green!30!white,right=-\pgflinewidth of tmp] (data) {32};
    \node[databox=4,right=-\pgflinewidth of data] (rptr) {return ptr};
    \node[databox=4,right=-\pgflinewidth of rptr] (data) {32};
    \node[databox=4,right=-\pgflinewidth of data] (data) {43};
    \node[databox=1,right=-\pgflinewidth of data] (data) {?};
  }
  \only<5,6>{%
    \node[databox=1,fill=lightgray,right=-\pgflinewidth of tmp] (tmp) {};
    \node[databox=4,right=-\pgflinewidth of tmp] (data) {32};
    \node[databox=4,right=-\pgflinewidth of data] (rptr) {return ptr};
    \node[databox=4,right=-\pgflinewidth of rptr] (data) {32};
    \node[databox=4,right=-\pgflinewidth of data] (data) {43};
    \node[databox=1,right=-\pgflinewidth of data] (data) {?};
  }
  \only<7>{%
    \node[databox=5,fill=lightgray,right=-\pgflinewidth of tmp] (tmp) {};
    \node[databox=4,right=-\pgflinewidth of tmp] (rptr) {return ptr};
    \node[databox=4,right=-\pgflinewidth of rptr] (data) {32};
    \node[databox=4,right=-\pgflinewidth of data] (data) {43};
    \node[databox=1,right=-\pgflinewidth of data] (data) {?};
  }
  \node[partright,right=-\pgflinewidth of data] {...};
  \node[linkedbyte,right=-\pgflinewidth-0.5*\DeltaWidht of tmp] (headofstack) {};
\end{scope}
%
\only<1>{\draw [->,draw=violet,thick] (EIP) to[out=-90,in=180] (l1);}
\only<2>{\draw [->,draw=violet,thick] (EIP) to[out=-90,in=180] (l3);}
\only<3>{\draw [->,draw=violet,thick] (EIP) to[out=-90,in=180] (l7);}
\only<4>{\draw [->,draw=violet,thick] (EIP) to[out=-90,in=180] (l8);}
\only<5>{\draw [->,draw=violet,thick] (EIP) to[out=-90,in=180] (l10);}
\only<6>{\draw [->,draw=violet,thick] (EIP) to[out=-90,in=180] (l11);}
\only<7>{\draw [->,draw=violet,thick] (EIP) to[out=-90,in=180] (l12);}
\only<8>{\draw [->,draw=violet,thick] (EIP) to[out=-90,in=180] (l4);}
\only<9>{\draw [->,draw=violet,thick] (EIP) to[out=-90,in=180] (l5);}
%
\only<3,4,5,6,7>{\draw [->,draw=violet,thick] (rptr) to[out=-90,in=0] ++(-0.5*\ByteWidht,-0.75*\ByteHeight)
		 -- ++(-3*\ByteWidht,0) to[out=180,in=180] (l4);
}
%
\only<1,8,9>{\draw [->,draw=violet,thick] (ESP) to[out=-90,in=90] (headofstack);}
\only<2,3,4,5,6,7>{\draw [->,draw=violet,thick] (ESP) to[out=-90,in=0] ++(-0.5*\ByteWidht,-\ByteHeight)
       to[out=180,in=0] ($(headofstack)+(0.5*\ByteWidht,\ByteHeight)$)
       to[out=180,in=90] (headofstack);
}
%
\begin{pgfonlayer}{background}
  \begin{scope}[scale=0.5, every node/.style={scale=0.5, text width=1.5\textwidth}]
    \only<2>{\qahigh{1,2}}
    \only<3>{\qahigh{3}}
    \only<4>{\qahigh{7}}
    \only<5>{\qahigh{8,9}}
    \only<6>{\qahigh{10}}
    \only<7>{\qahigh{11}}
    \only<8>{\qahigh{12}}
    \only<9>{\qahigh{4}}
  \end{scope}
\end{pgfonlayer}
    \end{tikzpicture}
  \end{figure}
  \end{block}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Соглашение о вызове
%%
\begin{frame}\frametitle{Соглашение о вызове}
  \begin{block}{}
  \end{block}
\end{frame}
\end{document}
